#!/bin/bash

main(){
    if [ "$(whoami)" != "root" ]; then
        echo "This program should be executed as root. Exiting"
        exit 1
    fi
    NEWIP="$(curl -s icanhazip.com)"
    
    source /etc/ipwarn.conf
    if [ "$NEWIP" != "$IP" ]; then
        sed -i -e 's/IP="'"${IP}"'"/IP="'"${NEWIP}"'"/g' /etc/ipwarn.conf
        echo "New ip is $NEWIP"
    
        #Telegram
        result="$(curl -s -X POST "https://api.telegram.org/bot$TEL_TOKEN/sendMessage" -d chat_id=$TEL_ID -d text="New ip is $NEWIP")"
        echo "Telegram warning sent"

        #GoDaddy
        curl -s -X PUT "https://api.godaddy.com/v1/domains/${GD_DOMAIN}/records/${GD_TYPE}/${GD_NAME}" \
	    -H "Authorization: sso-key ${GD_KEY}:${GD_SECRET}" \
	    -H "Content-Type: application/json" \
	    -d "[{\"data\": \"${NEWIP}\"}]"
	echo "GoDaddy record updated"
    fi
}

main

